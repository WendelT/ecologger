<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!--<script type="text/javascript" src="js/chart.min.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" ></script>
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.0.0/Chart.min.js" ></script>-->
    <script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
    <!--<script type="text/javascript" src="js/chart.min.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.5.1/chart.min.js" integrity="sha512-Wt1bJGtlnMtGP0dqNFH1xlkLBNpEodaiQ8ZN5JLA5wpc1sUlk/O5uuOMNgvzddzkpvZ9GLyYNa8w2s7rqiTk5Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    
    
    <title>Document</title>
</head>
<body>
    
    <h1>Teste de Gráfico</h1>
    <h2>up_tese_graph_50</h2>
    <!--reservado para o gráfico-->
    <div class="myChartDiv">
      <canvas id="myChart" width="600" height="400"></canvas> 
    </div>
    <!--formulário de seleção (importante ver se não tem o mesmo id de outro formulário no código)-->
    <form name="myForm" method="post" onsubmit="return savedata()">

        <input type="text" name="nome" id="cl" placeholder="Id Cliente"/>
        <!--Seleção de variáveis-->
        <select id="variablePosition">
            <option id="energia" value="5">Energia</option>
            <option id="w_ca" value="2">Potência Ativa</option>
            <option id="p_var" value="155">Potência Reativa</option>
            <option id="v_ab" value="176">Tensão de Linha AB</option>
            <option id="v_bc" value="179">Tensão de Linha BC</option>
            <option id="v_ca" value="182">Tensão de Linha CA</option>
            <option id="i_a" value="185">Corrente de Fase A</option>
            <option id="i_b" value="188">Corrente de Fase B</option>
            <option id="i_c" value="191">Corrente de Fase C</option>
            <option id="v_a" value="194">Tensão de Fase A</option>
            <option id="v_b" value="197">Tensão de Fase B</option>
            <option id="v_c" value="200">Tensão de Fase C</option>
        </select>

        <!--Escolha de dias-->
        <select id="selectDays" onchange="selectCheck(this);">
          <option id="select" value="select">Selecionar Período</option>
          <option id="today" value="today">Hoje</option>
          <option id="yesterday" value="yesterday">Ontem</option>
          <option id="last7Days" value="last7Days">últimos 7 dias</option>
          <option id="last30Days" value="last30Days">Últimos 30 dias</option>
          <option id="chooseRange" value="chooseRange">Escolher intervalo</option>
        </select>

        <!--Caso escolha a data de hoje-->
        <div id="ifToday" style="display: none">
          <input type="date" name="data_inicial" id="today1" onsubmit="return savedata()"/>
        </div >

        <!--Caso escolha a data de ontem-->
        <div id="ifYesterday" style="display: none">
          <input type="date" name="data_inicial" id="yesterday1" onsubmit="return savedata()"/>
        </div >

        <!--Caso escolha 7 dias atrás-->
        <div id="if7Days" style="display: none">
          <input type="date" name="data_inicial" id="last7" onsubmit="return savedata()"/>
          <input type="date" name="data_final" id="nowToday" onsubmit="return savedata()"/>
        </div>

        <!--Caso escolha 30 dias atrás-->
        <div id="if30Days" style="display: none">
            <input type="date" name="data_inicial" id="last30" onsubmit="return savedata()"/>
            <input type="date" name="data_final" id="nowToday2" onsubmit="return savedata()"/>
          </div>
        
        <!--Caso prefira escolher um intervalo-->
        <div id="ifRange" style="display: none">
          <input type="date" name="data_inicial" id="dt1" onsubmit="return savedata()"/>
          <input type="date" name="data_final" id="dt2" onsubmit="return savedata()"/>
        </div>

        <!--Pergunta por escolha de intervalo de tempo-->
        <select id="selectTime" style="display: none" onchange="selectCheck2(this);">
            <option id="no_choice" value="no_choice">Limitar por horário?</option>
            <option id="time_yes" value="time_yes">Sim</option>
            <option id="time_no" value="time_no">Não</option>
        </select>
        <!--Caso queira intervalo de tempo-->
        <div id="ifTime" style="display: none">
          <input type="time" name="time1" id="tm1" step="1" onsubmit="return savedata()"/>
          <input type="time" name="time2" id="tm2" step="1" onsubmit="return savedata()"/>
        </div>
        
        <input type="submit" id="update" name="submit" value="Modificar" />
        
    </form>
    
    <p>Tipo :  <span id="ener"></span></p><!--linha não necessária-->

    <script>
      var today_Date = new Date();
      var selectedRange;
      var finalRange;
      
      var time_range;
      var time_ans;
      function selectCheck2(that) {
        sessionStorage.removeItem("Range_2");
        if (that.value == "time_no") {
            //alert("check");
            document.getElementById("ifTime").style.display = "none";
            time_range='no';
            //sessionStorage.setItem("Range_2", time_range);
          
        } else if(that.value == "no_choice"){
            document.getElementById("ifTime").style.display = "none";
            time_range='no';
            
        }else {
            document.getElementById("ifTime").style.display = "block";
            time_range='yes';
            //sessionStorage.setItem("Range_2", time_range);
            //time_range='no';
            //sessionStorage.setItem("Range_2", time_range);
        }
        //time_ans;
        sessionStorage.setItem("Range_2", time_range);
    }
    
      function selectCheck(that) {
        if (that.value == "today") {
            //alert("check");
            document.getElementById('today1').valueAsDate = today_Date;
            document.getElementById("ifToday").style.display = "block";
            document.getElementById("selectTime").style.display = "block";
            document.getElementById("ifYesterday").style.display = "none";
            document.getElementById("if7Days").style.display = "none";
            document.getElementById("if30Days").style.display = "none";
            document.getElementById("ifRange").style.display = "none";
            selectedRange = 'hoje';
            sessionStorage.setItem("Range_1", selectedRange);
          
        } else if (that.value == "yesterday") {
            var yesterday_Date = new Date(today_Date);
            yesterday_Date.setDate(yesterday_Date.getDate() - 1);
            document.getElementById('yesterday1').valueAsDate = yesterday_Date;
            document.getElementById("ifYesterday").style.display = "block";
            document.getElementById("selectTime").style.display = "block";
            document.getElementById("ifToday").style.display = "none";
            document.getElementById("if7Days").style.display = "none";
            document.getElementById("if30Days").style.display = "none";
            document.getElementById("ifRange").style.display = "none";
            selectedRange = 'ontem';
            sessionStorage.setItem("Range_1", selectedRange);
          
        } else if (that.value == "last7Days") {
          //alert("check");
            var last_7Days = new Date(today_Date);
            last_7Days.setDate(today_Date.getDate() - 7);
            document.getElementById('last7').valueAsDate = last_7Days;
            document.getElementById('nowToday').valueAsDate = today_Date;
            document.getElementById("if7Days").style.display = "block";
            document.getElementById("ifToday").style.display = "none";
            document.getElementById("ifYesterday").style.display = "none";
            document.getElementById("if30Days").style.display = "none";
            document.getElementById("ifRange").style.display = "none";
            document.getElementById("selectTime").style.display = "none";
            selectedRange = '7daysAgo';
            sessionStorage.setItem("Range_1", selectedRange);
          
        } else if (that.value == "last30Days"){
            var last_30Days = new Date(today_Date);
            last_30Days.setDate(today_Date.getDate() - 30);
            document.getElementById('last30').valueAsDate = last_30Days;
            document.getElementById('nowToday2').valueAsDate = today_Date;
            document.getElementById("if30Days").style.display = "block";
            document.getElementById("ifToday").style.display = "none";
            document.getElementById("ifYesterday").style.display = "none";
            document.getElementById("if7Days").style.display = "none";
            document.getElementById("ifRange").style.display = "none";
            document.getElementById("selectTime").style.display = "none";
            selectedRange = '30daysAgo';
            sessionStorage.setItem("Range_1", selectedRange);
        } else if(that.value == "chooseRange"){
            document.getElementById("ifRange").style.display = "block";
            document.getElementById("if30Days").style.display = "none";
            document.getElementById("ifToday").style.display = "none";
            document.getElementById("ifYesterday").style.display = "none";
            document.getElementById("if7Days").style.display = "none";
            document.getElementById("selectTime").style.display = "none";
            selectedRange = 'chooseRange';
            sessionStorage.setItem("Range_1", selectedRange);
        }
        
        else {
            
            document.getElementById("ifToday").style.display = "none";
            document.getElementById("ifYesterday").style.display = "none";
            document.getElementById("if7Days").style.display = "none";
            document.getElementById("if30Days").style.display = "none";
            document.getElementById("ifRange").style.display = "none";
            document.getElementById("selectTime").style.display = "none";
        }
        finalRange = sessionStorage.getItem("Range_1");
        console.log(finalRange);
      }
      function savedata() { 
            var data;
            var data2;
            var data2 = document.getElementById("dt2");
            var time1 = document.getElementById("tm1");
            var time2 = document.getElementById("tm2");
            var client = document.getElementById("cl");
            var type = document.getElementById("variablePosition");
            
            console.log( document.getElementById("dt1").value);
            console.log( document.getElementById("dt2").value);
            console.log( document.getElementById("tm1").value);
            console.log( document.getElementById("tm2").value);
            console.log( document.getElementById("variablePosition").value);
            sessionStorage.setItem("cl", client.value);
            if(finalRange=='hoje'){
            data = document.getElementById("today1");
            sessionStorage.setItem("dt1", data.value);
            } else if (finalRange=='ontem'){
            data = document.getElementById("yesterday1");
            sessionStorage.setItem("dt1", data.value);
            } else if (finalRange=='7daysAgo'){
            data = document.getElementById("last7");
            data2 = document.getElementById("nowToday");
            sessionStorage.setItem("dt1", data.value);
            sessionStorage.setItem("dt2", data2.value);
            } else if (finalRange=='30daysAgo'){
            data = document.getElementById("last30");
            data2 = document.getElementById("nowToday2");
            sessionStorage.setItem("dt1", data.value);
            sessionStorage.setItem("dt2", data2.value);
            } else if (finalRange=='chooseRange'){
            data = document.getElementById("dt1");
            data2 = document.getElementById("dt2");
            sessionStorage.setItem("dt1", data.value);
            sessionStorage.setItem("dt2", data2.value);
            }
            
            
            sessionStorage.setItem("tm1", time1.value);
            sessionStorage.setItem("tm2", time2.value);
            sessionStorage.setItem("variablePosition", type.value);

            
            return true;
        }
      var th = sessionStorage.getItem("variablePosition");
      console.log(th);
      console.log(tm2.value);
      
    
      document.getElementById("ener").innerHTML = th; //não necessário
      
      let url1 = "http://ecologger.eng.br/graph_2408/data.php?range=" + sessionStorage.getItem("Range_1") + "&range2=" + sessionStorage.getItem("Range_2") + "&nome=" + sessionStorage.getItem("cl") + "&data_inicial=" + sessionStorage.getItem("dt1") + "&data_final=" + sessionStorage.getItem("dt2") + "&time1=" + sessionStorage.getItem("tm1") + "&time2=" + sessionStorage.getItem("tm2") + "&position=" + sessionStorage.getItem("variablePosition")+"&";
      
      console.log( url1.value);
      $(document).ready(function () {
            createGraph();
      });
        
      function createGraph()
          {
            {
              $.get(url1,
                function (data)
                {
                  
                  console.log(data);
                  var xAxis = [];
                  var yAxis = [];
                  var label1;
                  //preparando eixo x e eixo y com os dados do banco
                  for (var i in data) {
                   
                      xAxis.push(data[i].x);
                      yAxis.push(data[i].y);
                  
                      switch(th!=''){
                        case th==5:
                          yAxis[i] = yAxis[i]*10; //linha de correção (retirar quando problema do logger for resolvido)
                          label1 = 'Energia (kWh)';
                          break;
                        case th==2:
                          yAxis[i] = yAxis[i]/10; //linha de correção (retirar quando problema do logger for resolvido)
                          label1 = 'Potência Ativa (kW)';
                          break;
                        case th==155:
                          label1 = 'Potência Reativa (kVAr)';
                          break;
                        case th == 176:
                          label1 = 'Tensão de Linha AB (V)';
                          break;
                        case th == 179:
                          label1 = 'Tensão de Linha BC (V)';
                          break;
                        case th == 182:
                          label1 = 'Tensão de Linha CA (V)';
                          break;
                        case th == 185:
                          label1 = 'Corrente de Fase A (A)';
                          break;
                        case th == 188:
                          label1 = 'Corrente de Fase B (A)';
                          break;
                        case th == 191:
                          label1 = 'Corrente de Fase C (A)';
                          break;
                        case th == 194:
                          label1 = 'Tensão de Fase A (V)';
                          break;
                        case th == 197:
                          label1 = 'Tensão de Fase B (V)';
                          break;
                        case th == 197:
                          label1 = 'Tensão de Fase C (V)';
                          break;
                        default:
                          label1 = 'Variável não selecionada';
                      }
                  }
                  //preparando os dados com os eixos x e y
                  var dados = {
                    labels: xAxis,
                    datasets: [
                      {
                        label: label1,
                        backgroundColor: '#3DDC97',
                        borderColor: '#46d5f1',
                        hoverBackgroundColor: '#CCCCCC',
                        hoverBorderColor: '#666666',
                        data: yAxis
                      }
                    ]
                  };
                  //construção do gráfico
                  var gTarget = $("#myChart");
                  var myChart = new Chart(gTarget, {
                      type: 'line',
                      data: dados,
                      options: {
                        responsive: true,
    
                        scales: {
                          x: {
                            title: {
                                display: true,
                                text: 'Tempo'
                            },
                            ticks: {
                              maxTicksLimit:10,
                            }
                          },
                          y: {
                            
                            ticks: {
                              maxTicksLimit:10,
                              callback: function(value) {
                                    var dataRange = [
                                      { divider: 1e6, suffix: 'M' },
                                      { divider: 1e3, suffix: 'k' }
                                    ];
                                    function nFormatter(number) {
                                      for (var i = 0; i < dataRange.length; i++) {
                                        if (number >= dataRange[i].divider) {
                                          
                                          return (number / dataRange[i].divider).toLocaleString() + dataRange[i].suffix;
                                      }
                                    }
                                  
                                  return number;
                                }
                                return nFormatter(value);
                                /*const valueLegend = this.getLabelForValue(value);
                                function nFormatter(number){
                                  if(valueLegend.length>3){
                                    number = number/1000;
                                    number = Math.round(number*100)/100;
                                    return number.toLocaleString() + ' K';
                                  }
                                }
                                return nFormatter(value);*/
                                
                              }
                            }
                          }
                        }
                      },    
                  });
                  
                });
              } 
                   
            }
 
    </script>
</body>
</html>